{% extends "base.html" %}

{% block title %}Backtest Results - SuperTradeX{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Backtest Results</h1>
            <p class="mt-1 text-sm text-gray-500">
                {{ result.strategy.name }} - {{ result.strategy.coin.coin }}/{{ result.strategy.coin.pair }}
            </p>
        </div>
        <div class="flex space-x-4">
            <button onclick="exportResults()" 
                    class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                Export Results
            </button>
            <button onclick="runNewBacktest()" 
                    class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                Run New Backtest
            </button>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm font-medium text-gray-500">Total Return</h3>
            <p class="mt-2 text-3xl font-semibold {% if result.final_balance > result.initial_balance %}text-green-600{% else %}text-red-600{% endif %}">
                {{ "%.2f"|format((result.final_balance - result.initial_balance) / result.initial_balance * 100) }}%
            </p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm font-medium text-gray-500">Win Rate</h3>
            <p class="mt-2 text-3xl font-semibold text-gray-900">
                {{ "%.2f"|format(result.win_rate * 100) }}%
            </p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm font-medium text-gray-500">Profit Factor</h3>
            <p class="mt-2 text-3xl font-semibold text-gray-900">
                {{ "%.2f"|format(result.profit_factor) }}
            </p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-sm font-medium text-gray-500">Max Drawdown</h3>
            <p class="mt-2 text-3xl font-semibold text-red-600">
                {{ "%.2f"|format(result.max_drawdown * 100) }}%
            </p>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Equity Curve -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Equity Curve</h3>
            <canvas id="equityChart" height="300"></canvas>
        </div>
        
        <!-- Drawdown Chart -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Drawdown</h3>
            <canvas id="drawdownChart" height="300"></canvas>
        </div>
        
        <!-- Monthly Returns -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Monthly Returns</h3>
            <canvas id="monthlyReturnsChart" height="300"></canvas>
        </div>
        
        <!-- Trade Distribution -->
        <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Trade Distribution</h3>
            <canvas id="tradeDistributionChart" height="300"></canvas>
        </div>
    </div>

    <!-- Trade List -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Trade History</h3>
        </div>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P/L</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for trade in result.results_data.trades %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ trade.timestamp }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                   {% if trade.type == 'BUY' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {{ trade.type }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ "%.8f"|format(trade.price) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ "%.4f"|format(trade.amount) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ "%.2f"|format(trade.total) }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm {% if trade.profit_loss > 0 %}text-green-600{% else %}text-red-600{% endif %}">
                        {{ "%.2f"|format(trade.profit_loss) }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Initialize charts when the page loads
document.addEventListener('DOMContentLoaded', function() {
    // Equity Curve Chart
    new Chart(document.getElementById('equityChart'), {
        type: 'line',
        data: {
            labels: {{ result.results_data.equity_curve.timestamps|tojson }},
            datasets: [{
                label: 'Equity',
                data: {{ result.results_data.equity_curve.values|tojson }},
                borderColor: 'rgb(59, 130, 246)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Drawdown Chart
    new Chart(document.getElementById('drawdownChart'), {
        type: 'line',
        data: {
            labels: {{ result.results_data.drawdown.timestamps|tojson }},
            datasets: [{
                label: 'Drawdown',
                data: {{ result.results_data.drawdown.values|tojson }},
                borderColor: 'rgb(239, 68, 68)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Monthly Returns Chart
    new Chart(document.getElementById('monthlyReturnsChart'), {
        type: 'bar',
        data: {
            labels: {{ result.results_data.monthly_returns.labels|tojson }},
            datasets: [{
                label: 'Monthly Returns',
                data: {{ result.results_data.monthly_returns.values|tojson }},
                backgroundColor: function(context) {
                    const value = context.raw;
                    return value >= 0 ? 'rgba(34, 197, 94, 0.5)' : 'rgba(239, 68, 68, 0.5)';
                },
                borderColor: function(context) {
                    const value = context.raw;
                    return value >= 0 ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)';
                },
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Trade Distribution Chart
    new Chart(document.getElementById('tradeDistributionChart'), {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Trades',
                data: {{ result.results_data.trade_distribution|tojson }},
                backgroundColor: function(context) {
                    const value = context.raw.y;
                    return value >= 0 ? 'rgba(34, 197, 94, 0.5)' : 'rgba(239, 68, 68, 0.5)';
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day'
                    }
                }
            }
        }
    });
});

function exportResults() {
    // Implement export functionality
    const data = {
        strategy: {{ result.strategy.name|tojson }},
        parameters: {{ result.parameters|tojson }},
        results: {{ result.results_data|tojson }}
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backtest_results_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function runNewBacktest() {
    window.location.href = "{{ url_for('views.backtest') }}";
}
</script>
{% endblock %} 