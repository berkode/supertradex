{% extends "base.html" %}

{% block title %}Paper Trading - SuperTradeX{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold">Paper Trading Dashboard</h1>
        <button id="newTradeBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
            New Trade
        </button>
    </div>

    <!-- Active Positions -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">Active Positions</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">Symbol</th>
                        <th class="py-2 px-4 border-b">Amount</th>
                        <th class="py-2 px-4 border-b">Entry Price</th>
                        <th class="py-2 px-4 border-b">Current Price</th>
                        <th class="py-2 px-4 border-b">P/L</th>
                        <th class="py-2 px-4 border-b">Actions</th>
                    </tr>
                </thead>
                <tbody id="positionsTableBody">
                    {% if positions %}
                        {% for symbol, position in positions.items() %}
                        <tr>
                            <td class="py-2 px-4 border-b">{{ symbol }}</td>
                            <td class="py-2 px-4 border-b">{{ position.amount }}</td>
                            <td class="py-2 px-4 border-b">${{ "%.2f"|format(position.average_price) }}</td>
                            <td class="py-2 px-4 border-b" id="current-price-{{ symbol }}">Loading...</td>
                            <td class="py-2 px-4 border-b" id="pnl-{{ symbol }}">Loading...</td>
                            <td class="py-2 px-4 border-b">
                                <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm close-position" data-symbol="{{ symbol }}">
                                    Close
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" class="py-4 text-center">No active positions</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Alerts -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Alerts</h2>
            <button id="newAlertBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
                New Alert
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">Strategy</th>
                        <th class="py-2 px-4 border-b">Symbol</th>
                        <th class="py-2 px-4 border-b">Condition</th>
                        <th class="py-2 px-4 border-b">Action</th>
                        <th class="py-2 px-4 border-b">Price</th>
                        <th class="py-2 px-4 border-b">Amount</th>
                        <th class="py-2 px-4 border-b">Status</th>
                        <th class="py-2 px-4 border-b">Actions</th>
                    </tr>
                </thead>
                <tbody id="alertsTableBody">
                    {% if alerts %}
                        {% for alert in alerts %}
                        <tr>
                            <td class="py-2 px-4 border-b">{{ alert.strategy.name }}</td>
                            <td class="py-2 px-4 border-b">{{ alert.coin.coin }}/{{ alert.coin.pair }}</td>
                            <td class="py-2 px-4 border-b">{{ alert.condition }}</td>
                            <td class="py-2 px-4 border-b">{{ alert.action }}</td>
                            <td class="py-2 px-4 border-b">${{ "%.2f"|format(alert.price) }}</td>
                            <td class="py-2 px-4 border-b">{{ alert.amount }}</td>
                            <td class="py-2 px-4 border-b">
                                <span class="px-2 py-1 rounded text-sm {% if alert.is_active %}bg-green-200 text-green-800{% else %}bg-red-200 text-red-800{% endif %}">
                                    {{ "Active" if alert.is_active else "Inactive" }}
                                </span>
                            </td>
                            <td class="py-2 px-4 border-b">
                                <button class="toggle-alert bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded text-sm mr-2" data-alert-id="{{ alert.id }}">
                                    {{ "Deactivate" if alert.is_active else "Activate" }}
                                </button>
                                <button class="delete-alert bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm" data-alert-id="{{ alert.id }}">
                                    Delete
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="py-4 text-center">No alerts configured</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Recent Trades -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold mb-4">Recent Trades</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b">Time</th>
                        <th class="py-2 px-4 border-b">Strategy</th>
                        <th class="py-2 px-4 border-b">Symbol</th>
                        <th class="py-2 px-4 border-b">Type</th>
                        <th class="py-2 px-4 border-b">Price</th>
                        <th class="py-2 px-4 border-b">Amount</th>
                        <th class="py-2 px-4 border-b">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% if recent_trades %}
                        {% for trade in recent_trades %}
                        <tr>
                            <td class="py-2 px-4 border-b">{{ trade.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td class="py-2 px-4 border-b">{{ trade.strategy.name }}</td>
                            <td class="py-2 px-4 border-b">{{ trade.coin.coin }}/{{ trade.coin.pair }}</td>
                            <td class="py-2 px-4 border-b">
                                <span class="px-2 py-1 rounded text-sm {% if trade.type == 'BUY' %}bg-green-200 text-green-800{% else %}bg-red-200 text-red-800{% endif %}">
                                    {{ trade.type }}
                                </span>
                            </td>
                            <td class="py-2 px-4 border-b">${{ "%.2f"|format(trade.price) }}</td>
                            <td class="py-2 px-4 border-b">{{ trade.amount }}</td>
                            <td class="py-2 px-4 border-b">${{ "%.2f"|format(trade.total) }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="py-4 text-center">No recent trades</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Trade Modal -->
<div id="newTradeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">New Paper Trade</h3>
            <form id="newTradeForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="strategy">
                        Strategy
                    </label>
                    <select id="strategy" name="strategy_id" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">Select a strategy</option>
                        {% for strategy in strategies %}
                        <option value="{{ strategy.id }}">{{ strategy.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="coin">
                        Symbol
                    </label>
                    <select id="coin" name="coin_id" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">Select a symbol</option>
                        {% for coin in coins %}
                        <option value="{{ coin.id }}">{{ coin.coin }}/{{ coin.pair }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="action">
                        Action
                    </label>
                    <select id="action" name="action" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="BUY">Buy</option>
                        <option value="SELL">Sell</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="price">
                        Price
                    </label>
                    <input type="number" step="0.00000001" id="price" name="price" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="amount">
                        Amount
                    </label>
                    <input type="number" step="0.00000001" id="amount" name="amount" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="flex justify-end">
                    <button type="button" id="cancelTradeBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        Execute Trade
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- New Alert Modal -->
<div id="newAlertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">New Alert</h3>
            <form id="newAlertForm">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="alertStrategy">
                        Strategy
                    </label>
                    <select id="alertStrategy" name="strategy_id" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">Select a strategy</option>
                        {% for strategy in strategies %}
                        <option value="{{ strategy.id }}">{{ strategy.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="alertCoin">
                        Symbol
                    </label>
                    <select id="alertCoin" name="coin_id" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">Select a symbol</option>
                        {% for coin in coins %}
                        <option value="{{ coin.id }}">{{ coin.coin }}/{{ coin.pair }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="condition">
                        Condition
                    </label>
                    <input type="text" id="condition" name="condition" placeholder="e.g., RSI < 30" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="alertAction">
                        Action
                    </label>
                    <select id="alertAction" name="action" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="BUY">Buy</option>
                        <option value="SELL">Sell</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="alertPrice">
                        Price
                    </label>
                    <input type="number" step="0.00000001" id="alertPrice" name="price" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="alertAmount">
                        Amount
                    </label>
                    <input type="number" step="0.00000001" id="alertAmount" name="amount" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="flex justify-end">
                    <button type="button" id="cancelAlertBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">
                        Cancel
                    </button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
                        Create Alert
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // New Trade Modal
        const newTradeBtn = document.getElementById('newTradeBtn');
        const newTradeModal = document.getElementById('newTradeModal');
        const cancelTradeBtn = document.getElementById('cancelTradeBtn');
        const newTradeForm = document.getElementById('newTradeForm');
        
        newTradeBtn.addEventListener('click', function() {
            newTradeModal.classList.remove('hidden');
        });
        
        cancelTradeBtn.addEventListener('click', function() {
            newTradeModal.classList.add('hidden');
        });
        
        newTradeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                strategy_id: document.getElementById('strategy').value,
                coin_id: document.getElementById('coin').value,
                action: document.getElementById('action').value,
                price: parseFloat(document.getElementById('price').value),
                amount: parseFloat(document.getElementById('amount').value)
            };
            
            fetch('/paper-trading/trade', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while executing the trade');
            });
            
            newTradeModal.classList.add('hidden');
        });
        
        // New Alert Modal
        const newAlertBtn = document.getElementById('newAlertBtn');
        const newAlertModal = document.getElementById('newAlertModal');
        const cancelAlertBtn = document.getElementById('cancelAlertBtn');
        const newAlertForm = document.getElementById('newAlertForm');
        
        newAlertBtn.addEventListener('click', function() {
            newAlertModal.classList.remove('hidden');
        });
        
        cancelAlertBtn.addEventListener('click', function() {
            newAlertModal.classList.add('hidden');
        });
        
        newAlertForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                strategy_id: document.getElementById('alertStrategy').value,
                coin_id: document.getElementById('alertCoin').value,
                condition: document.getElementById('condition').value,
                action: document.getElementById('alertAction').value,
                price: parseFloat(document.getElementById('alertPrice').value),
                amount: parseFloat(document.getElementById('alertAmount').value)
            };
            
            fetch('/alerts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while creating the alert');
            });
            
            newAlertModal.classList.add('hidden');
        });
        
        // Toggle Alert
        document.querySelectorAll('.toggle-alert').forEach(button => {
            button.addEventListener('click', function() {
                const alertId = this.getAttribute('data-alert-id');
                
                fetch(`/alerts/${alertId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while toggling the alert');
                });
            });
        });
        
        // Delete Alert
        document.querySelectorAll('.delete-alert').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to delete this alert?')) {
                    const alertId = this.getAttribute('data-alert-id');
                    
                    fetch(`/alerts/${alertId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while deleting the alert');
                    });
                }
            });
        });
        
        // Close Position
        document.querySelectorAll('.close-position').forEach(button => {
            button.addEventListener('click', function() {
                const symbol = this.getAttribute('data-symbol');
                const [coin, pair] = symbol.split('/');
                
                // Find the coin ID
                const coinSelect = document.getElementById('coin');
                let coinId = null;
                
                for (let i = 0; i < coinSelect.options.length; i++) {
                    const option = coinSelect.options[i];
                    if (option.text === symbol) {
                        coinId = option.value;
                        break;
                    }
                }
                
                if (!coinId) {
                    alert('Error: Could not find coin ID');
                    return;
                }
                
                // Get current price
                const currentPriceElement = document.getElementById(`current-price-${symbol}`);
                const currentPrice = parseFloat(currentPriceElement.textContent.replace('$', ''));
                
                if (isNaN(currentPrice)) {
                    alert('Error: Could not determine current price');
                    return;
                }
                
                // Get position amount
                const positionRow = this.closest('tr');
                const amountElement = positionRow.querySelector('td:nth-child(2)');
                const amount = parseFloat(amountElement.textContent);
                
                if (isNaN(amount)) {
                    alert('Error: Could not determine position amount');
                    return;
                }
                
                // Execute close trade
                const formData = {
                    strategy_id: document.getElementById('strategy').value || 1, // Default to first strategy if not selected
                    coin_id: coinId,
                    action: amount > 0 ? 'SELL' : 'BUY', // Opposite of current position
                    price: currentPrice,
                    amount: Math.abs(amount) // Absolute value of the position
                };
                
                fetch('/paper-trading/trade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Position closed successfully');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while closing the position');
                });
            });
        });
        
        // Update current prices and P/L
        function updatePricesAndPnL() {
            const positions = document.querySelectorAll('#positionsTableBody tr');
            
            positions.forEach(row => {
                const symbolCell = row.querySelector('td:first-child');
                if (!symbolCell) return;
                
                const symbol = symbolCell.textContent;
                const currentPriceElement = document.getElementById(`current-price-${symbol}`);
                const pnlElement = document.getElementById(`pnl-${symbol}`);
                
                if (!currentPriceElement || !pnlElement) return;
                
                // In a real application, you would fetch the current price from an API
                // For this example, we'll simulate a price update
                const basePrice = parseFloat(currentPriceElement.textContent.replace('$', ''));
                if (isNaN(basePrice)) return;
                
                // Simulate price change (Â±2%)
                const randomChange = (Math.random() * 0.04) - 0.02;
                const newPrice = basePrice * (1 + randomChange);
                currentPriceElement.textContent = '$' + newPrice.toFixed(2);
                
                // Calculate P/L
                const amountCell = row.querySelector('td:nth-child(2)');
                const entryPriceCell = row.querySelector('td:nth-child(3)');
                
                if (amountCell && entryPriceCell) {
                    const amount = parseFloat(amountCell.textContent);
                    const entryPrice = parseFloat(entryPriceCell.textContent.replace('$', ''));
                    
                    if (!isNaN(amount) && !isNaN(entryPrice)) {
                        const pnl = amount * (newPrice - entryPrice);
                        const pnlPercent = (pnl / (amount * entryPrice)) * 100;
                        
                        pnlElement.textContent = '$' + pnl.toFixed(2) + ' (' + pnlPercent.toFixed(2) + '%)';
                        pnlElement.className = pnl >= 0 ? 'text-green-600' : 'text-red-600';
                    }
                }
            });
        }
        
        // Update prices every 5 seconds
        setInterval(updatePricesAndPnL, 5000);
        updatePricesAndPnL(); // Initial update
    });
</script>
{% endblock %} 